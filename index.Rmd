---
title: "Retinalogik vs HFA study"
author: "[Eadie Technologies, Inc.](https://www.eadietech.com/)"
date: "2025-02-06"
output: 
  html_document:
    theme: yeti
    code_folding: hide
    toc: true
    toc_depth: 2
    toc_float: 
      collapsed: true
    includes:
        after_body: footer.html
---

## Setup

### Versioning

Last updated on `r format(Sys.time(), '%Y-%b-%d')` at `r format(Sys.time(), '%I:%M %p')`.

* 2025-Feb-06: Created git & RStudio project

### Acknowledgements
Data collected by Research Assistant Reann Post and Research Coordinator Lynn Murphy.

```{r setup, collapse=TRUE}

# load packages
library(tidyverse)
library(here)
library(DT)
library(plotly)
library(viridis)
library(svglite)
library(htmltools)

sessionInfo()

# default chunk options
knitr::opts_chunk$set(
  comment = '>', cache = TRUE, collapse = TRUE, cache = FALSE, dev= c("png")
  )

# load processed data
load(here("dBdat.Rda"))

```

# Study summary
We compared 24-2 Full Threshold visual field (VF) test results between Retinalogik and Humphrey Field Analyzer (HFA) in patients with early glaucoma and moderate to advanced glaucoma.

# Methods (briefly)
## Subjects

Eligible participants were identified among patients of Dr. Brennan Eadie at the Eadie Eye Centre. If deemed eligible for the study, subjects were recruited consecutively.

Each participant underwent 5 study visits, whereupon they performed a VF test on both eyes and on both devices, with the order of devices randomized during the baseline 1st study visit.

The study adhered to the tenets of the Declaration of Helsinki for research involving human subjects and the protocol was approved by the Nova Scotia Health Research Ethics Board (#1030608). All participants gave their written informed consent before enrollment in the study.

## Analysis
All OS data will be transposed to OD format before analyses. A total of `r dBdat %>% group_by(id, age, eye, device) %>% distinct(duration) %>% nrow()` VF datasets were collected from `r length(unique(dBdat$id))` participants aged `r min(dBdat$age)` to `r max(dBdat$age)` (*M* = `r round(mean(dBdat$age), 2)`, *SD* = `r round(sd(dBdat$age), 2)`).

# Results
## Plots
```{r individualplots, warning=FALSE}
library(ggplot2)
library(slickR)

dBdat %>%
  mutate(dB = as.numeric(dB)) %>%
  filter(device == "hfa") %>%
  group_by(id, visit, eye) %>%
  arrange(id, visit, eye) %>%
  # Use the group_by %>% nest pattern to group data by id
  nest() %>% 
  # Use map2 so the id can be used as the title
  mutate(graphs = map2(data, id,
                       ~ggplot(data = .x, aes(x, y, dB)) +
                         geom_raster(aes(x = x, y = y, fill = dB)) +
                         geom_text(aes(label = dB, x = x, y = y), size = 8) +
                         coord_fixed(ratio = 1) +
                         scale_fill_gradientn(colours = viridis(47), limits = c(-1, 46),
                                              na.value="darkred") +
                         theme_bw() +
                         ggtitle(paste0("HFA ", id, " Visit ", visit, " Eye: ", eye))
                       )
         ) %>% 
  # pull is the pipe-able equivalent of .[['graphs']]
  pull(graphs) %>% 
  # Return the svg of graphs
  map(function(gr) svglite::xmlSVG(show(gr), standalone = TRUE)) -> 
  hfa_individual_graphs

dBdat %>%
  mutate(dB = as.numeric(dB)) %>%
  filter(device == "retinalogik") %>%
  group_by(id, visit, eye) %>%
  arrange(id, visit, eye) %>%
  # Use the group_by %>% nest pattern to group data by id
  nest() %>% 
  # Use map2 so the id can be used as the title
  mutate(graphs = map2(data, id,
                       ~ggplot(data = .x, aes(x, y, dB)) +
                         geom_raster(aes(x = x, y = y, fill = dB)) +
                         geom_text(aes(label = dB, x = x, y = y), size = 8) +
                         coord_fixed(ratio = 1) +
                         scale_fill_gradientn(colours = viridis(47), limits = c(-1, 46),
                                              na.value="darkred") +
                         theme_bw() +
                         ggtitle(paste0("Retinalogik ", id, " Visit ", visit, " Eye: ", eye))
                       )
         ) %>% 
  # pull is the pipe-able equivalent of .[['graphs']]
  pull(graphs) %>% 
  # Return the svg of graphs
  map(function(gr) svglite::xmlSVG(show(gr), standalone = TRUE)) -> 
  rt_individual_graphs

# carousels
hfa_plots <- slickR(hfa_individual_graphs, height = 350, width = "95%", padding = 0) +
  settings(slidesToShow = 2, slidesToScroll = 2)

# carousels
rt_plots <- slickR(rt_individual_graphs, height = 350, width = "95%", padding = 0) +
  settings(slidesToShow = 2, slidesToScroll = 2)

hfa_plots %synch% rt_plots
```

# Discussion
